<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Asend Health</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  
  <!-- Dashboard Content -->
  <header>
    <nav>
      <ul>
        <li><a href="/dashboard" class="active">Dashboard</a></li>
        <li><a href="/maya">Maya</a></li>
        <li><a href="/appointments">Appointments</a></li>
        <li><a href="/feedback">Feedback</a></li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <div class="section" id="personal-info-section">
      <h2>Personal Information</h2>
      <div id="patient-info">
        <!-- Patient Info will be populated here -->
      </div>
    </div>
    <div class="section" id="medical-conditions-section">
      <h2>Medical Conditions</h2>
      <div id="medical-history">
        <!-- Medical Conditions will be populated here -->
      </div>
    </div>
    <div class="section" id="medications-section">
      <h2>Medications</h2>
      <div id="medications">
        <!-- Medications will be populated here -->
      </div>
    </div>
    <div class="section" id="activity-log-section">
      <h2>Activity Log</h2>
      <div id="activity-log">
        <!-- Activity Log will be populated here -->
      </div>
    </div>
    <div class="section" id="health-metrics-section">
      <h2>Health Metrics</h2>
      <div id="health-metrics">
        <!-- Health Metrics Content -->
      </div>
    </div>
    <div class="section" id="alerts-section">
      <h2>Alerts</h2>
      <div id="alerts">
        <!-- Alerts will be populated here -->
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      // Retrieve the pointId from localStorage
      const pointId = localStorage.getItem("pointId");
      console.log("Point ID from localStorage:", pointId);
      
      if (!pointId) {
        console.error("Point ID not found in localStorage");
        return;
      }
  
      try {
        const response = await fetch("/api/patient-records", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ point_id: pointId })
        });
  
        console.log("API Response Status:", response.status);
  
        if (response.ok) {
          const patientData = await response.json();
          console.log("Patient Data received:", patientData);
  
          if (patientData) {
            const payload = patientData;
  
            // Populate Personal Information
            const patientInfoElement = document.getElementById("patient-info");
            if (patientInfoElement) {
              patientInfoElement.innerHTML = `
                <p><strong>GUID:</strong> ${payload.guid}</p>
                <p><strong>Name:</strong> ${payload.name}</p>
                <p><strong>Age:</strong> ${payload.age}</p>
                <p><strong>Gender:</strong> ${payload.gender}</p>
                <p><strong>Location:</strong> ${payload.location}</p>
                <p><strong>Conditions:</strong> ${payload.conditions.join(", ")}</p>
              `;
            } else {
              console.error("Patient Info Element not found");
            }
  
            // Populate Medical Conditions
            const medicalHistoryElement = document.getElementById("medical-history");
            if (medicalHistoryElement) {
              const assessment = payload.assessment.map(assessment => `
                <div>
                  <p><strong>Timestamp:</strong> ${new Date(assessment.timestamp).toLocaleString()}</p>
                  <p><strong>Observation:</strong> ${assessment.observation}</p>
                  <p><strong>Recommendation:</strong> ${assessment.recommendation}</p>
                </div>
              `).join("");
              medicalHistoryElement.innerHTML = assessment;
            } else {
              console.error("Medical History Element not found");
            }
  
            // Populate Medications
            const medicationsElement = document.getElementById("medications");
            if (medicationsElement) {
              const medications = payload.medications.map(med => `
                <div>
                  <p><strong>Name:</strong> ${med.name}</p>
                  <p><strong>Dosage:</strong> ${med.dosage}</p>
                  <p><strong>Schedule:</strong> ${med.schedule}</p>
                </div>
              `).join("");
              medicationsElement.innerHTML = medications;
            } else {
              console.error("Medications Element not found");
            }
  
            // Populate Activity Log
            const activityLogElement = document.getElementById("activity-log");
            if (activityLogElement) {
              const activities = payload.activity_log.map(activity => `
                <div>
                  <p><strong>Date:</strong> ${activity.date}</p>
                  <p><strong>Activity:</strong> ${activity.activity}</p>
                  <p><strong>Duration:</strong> ${activity.duration}</p>
                </div>
              `).join("");
              activityLogElement.innerHTML = activities;
            } else {
              console.error("Activity Log Element not found");
            }
  
            // Populate Alerts
            const alertsElement = document.getElementById("alerts");
            if (alertsElement) {
              const alerts = payload.alerts.map(alert => `
                <div>
                  <p><strong>Timestamp:</strong> ${new Date(alert.timestamp).toLocaleString()}</p>
                  <p><strong>Message:</strong> ${alert.message}</p>
                </div>
              `).join("");
              alertsElement.innerHTML = alerts;
            } else {
              console.error("Alerts Element not found");
            }
          } else {
            console.error("Patient data is missing or invalid");
          }
        } else {
          console.error("Failed to fetch patient data. Status:", response.status);
        }
      } catch (error) {
        console.error("Error fetching patient data:", error);
      }
    });
  
    document.getElementById("logoutBtn").addEventListener("click", function(e) {
      e.preventDefault();
      localStorage.removeItem("pointId");
      localStorage.removeItem("patientGuid");
      window.location.href = "/login";
    });
  </script>
</body>
</html>
